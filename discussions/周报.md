# 周报

​	

## 3-10 ~ 3-14

有个棘手的问题，个人理解组件化是将调度器内核最小化，以至于最小化都能运行，后面进行扩展也只需要添加新的组件。但是对于RTOS来说，或者对这个项目来说，功能上已经相对完善，耦合性也较高。需要依赖堆栈的内存分配去管理任务栈，依赖定时器实现时钟戳以及闹钟，依赖时钟队列管理延时任务等。

组件化在于如何在最小化内核的同时，仍然保持系统的可扩展性和模块的独立性

这一阶段计划：

- 将内核最小化，分离与内核关联不大的代码，以组件的形式独立。
  - 不再采用ucosii的代码结构
- 目前仅支持stm32f401，需要往多处理适配
  - 启动内核外设方式不同，需要统一接口
  - 需要解决memory.x链接脚本问题
  - 时钟问题，定时器是由系统时钟提供的时钟信号，需要确定每款芯片的时钟



Qemu去验证不同芯片下的可行性

​	

### memory.x解决方案

因为不同芯片有不同大小的FLASH和RAM，所有链接器所需要的 `memory.x` 也不同。有两种方案：

- 根据芯片类型去生成对应的`memory.x`，就跟embassy一样，embassy-stm32的构建脚本build.rs，会识别用户传过去的`feature`去生成 `memory.x` 。
- 另一种就是用户自行添加所用芯片的 `memory.x` 

但我看到`stm32-metapac`提供接口，可以自动生成`memory.x`，原理应该第一种差不多

但目前我没有去验证其他芯片，是否会正确生成

​	

### Question

![image-20250313162051984](./graph/image-20250313162051984.png)

https://rustcc.cn/article?id=04fbf832-0395-49dc-ab60-ef4496a34060

在一个 `no_std` 环境中使用了 `panic = "unwind"`，而 `no_std` 环境不支持栈展开（unwinding）。Rust 的标准库 (`std`) 提供了栈展开的支持，但在 `no_std` 环境中，默认情况下只能使用 `panic = "abort"`

设置 `panic = "abort"`：

```
[profile.dev]
panic = "abort"

[profile.release]
panic = "abort"
```

但是没必要，这里报错归根到底是因为我cargo build没有指定平台 `thumbv7em-none-eabi` 导致的，会配置隐式地支持 `panic = "abort"`

	
​	

## 3-17 ~ 3.21

目前已经大致完成芯片架构扩展，不再单一支持F401

#### 时钟树配置

RCC的初始化需要对锁相环PLL配置，但纵使所有芯片的HSE都为8M，一旦需要的系统时钟不同，那么PLL锁相环参数M、N、P、Q也是不同的。

目前，尚未实现统一的接口来抽象时钟树配置。与 **Embassy** 等框架提供的完整 STM32 外设接口相比，需要手动配置时钟树

用于定义内存布局`memory.x` 通过 **stm32metapac** 提供的接口动态生成 `memory.x`，确保其与目标芯片的内存布局一致。

#### 定时器

定时器，需要解决的是如何获取系统时钟。然而，**stm32metapac** 并未像 **stm32-hal** 那样提供直接获取时钟频率的接口。为了解决这一问题，设计了专用的函数来计算 `SYSCLK` 和 `APB` 总线的时钟频率。会在os初始化时被调用，以确保定时器能够基于正确的时钟频率运行

另外像 `embassy` 那样支持了通过 `feature` 设置定时的脉冲频率

#### 外设接口

为了支持更多 STM32 芯片，激活 **stm32metapac** 的关于芯片的 `feature` 实现。编译时启用特定芯片的 `feature`，可以动态加载对应芯片的外设寄存器定义和访问接口。

​	

同时展开对ucos底层函数的重写

#### 全局分配器（Global Allocator）的实现

在之前的实现中，系统并不支持像`String`，`Vec`这种动态大小的类型。需要完成 `global allocator` 的实现。

之前实现栈分配器的时候，也是对堆内存进行分配。采用的是 linked list allocator 链式分配器的方案来管理堆内存。链式分配器通过维护一个空闲内存块的链表，动态分配和释放内存。

由于使用了 `flip-link` 链接器，`.data` 和 `.bss` 段被放置在地址空间的高位，所以可以在任务栈之后开辟了一块专用的堆内存区域，供全局分配器使用



另外完成了部分关于ucos中os_core和os_task的重写工作
